# 최초 1회 실행
# ------------------------------------------------------------
# 부모 커밋 없는 새 브랜치 students 생성 (작업 디렉터리 내용은 main 그대로 유지)
# git checkout --orphan students

# 스테이징·작업 디렉터리를 비움 (main에서 넘어온 파일 전부 제거)
# git reset --hard

# 빈 커밋 하나로 브랜치 시작 (원격에 push할 최소 한 개 커밋 필요)
# git commit --allow-empty -m "Initialising students branch"
# git push origin students
# git checkout main
# ------------------------------------------------------------

name: Publish to students branch

on:                            # 실행 조건
  push:
    branches: main             # main 브랜치에 push할 때 자동 실행
  workflow_dispatch:           # GitHub Actions 탭에서 수동 실행 버튼 활성화

jobs:
  convert-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. main 브랜치만 Github Actions 서버로 clone (students 브랜치의 존재 여부나 최신 상태는 모름)
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. Quarto CLI 설치
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      # 3. _out 디렉터리 만들고, .qmd를 여기로 직접 변환
      #    exercises/assignments에 ipynb 안 만듦 → origin/students 브랜치에 있는 파일과 충돌하지 않기 위해서
      - name: Prepare _out and convert qmd to ipynb
        run: |
          mkdir -p _out/exercises _out/assignments
          cp README.md pixi.toml _out/ 2>/dev/null || true
          for f in exercises/*.qmd assignments/*.qmd; do
            if [ -f "$f" ]; then
              dir=$(dirname "$f")
              base=$(basename "$f" .qmd)
              quarto convert "$f" --output "_out/$dir/$base.ipynb"
            fi
          done
          cat > _out/.gitignore << 'EOF'
          # pixi environments
          .pixi/*
          !.pixi/config.toml
          # VSCode & Jupyter
          .vscode/
          .ipynb_checkpoints/
          EOF

      # 4. students 브랜치로 전환  (기존 히스토리 유지 → 변경분만 push)
      #    origin/students 브랜치 정보를 가져와서, Github Actions 서버에 students 로컬 브랜치(또는 이미 있으면 리셋)를 만들고 students 로컬 브랜치로 이동
      #    tracked 파일 → origin/students 내용으로 교체 / untracked 파일 → 건드리지 않고 그대로 유지 (단, 같은 경로에 충돌이 생기면 에러)
      - name: Fetch and checkout students branch
        run: |
          git fetch origin students
          git checkout -B students origin/students

      # 5. 작업 디렉터리를 _out 내용으로 교체
      - name: Replace tree with students content
        run: |
          git ls-files | xargs -r rm -f
          git ls-files -z --directory | sort -z -r | xargs -0 rmdir 2>/dev/null || true
          cp -r _out/* .
          cp _out/.gitignore .
          rm -rf _out

      # 6. 변경된 파일만 커밋 후 일반 push → 변경분(delta)만 커밋
      - name: Commit and push to students
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update ipynb from main (qmd convert)"
          fi
          git push origin students