name: Publish to students branch

on:                            # 실행 조건
  push:
    branches: main             # main 브랜치에 push할 때 자동 실행
  workflow_dispatch:           # GitHub Actions 탭에서 수동 실행 버튼 활성화

jobs:
  convert-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. main 브랜치만 clone (students 브랜치는 가져오지 않음)
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. Quarto CLI 설치
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      # 3. main 기준으로 .qmd → .ipynb 변환 (같은 디렉터리에 .ipynb 생성)
      - name: Convert qmd to ipynb
        run: |
          for f in exercises/*.qmd assignments/*.qmd; do
            [ -f "$f" ] && quarto convert --to ipynb "$f"
          done

      # 4. students 브랜치에 넣을 내용만 모음
      - name: Prepare students branch content
        run: |
          mkdir -p students_out/exercises students_out/assignments
          cp README.md pixi.toml students_out/ 2>/dev/null || true
          cp exercises/*.ipynb students_out/exercises/ 2>/dev/null || true
          cp assignments/*.ipynb students_out/assignments/ 2>/dev/null || true
          cat > students_out/.gitignore << 'EOF'
          .pixi/*
          !.pixi/config.toml
          .ipynb_checkpoints/
          EOF

      # 5. 로컬에 students 브랜치 생성 (--orphan = 커밋 히스토리 없음)
      #    작업 디렉터리는 그대로 → main 내용 + students_out 모두 있는 상태
      - name: Create students branch
        run: git checkout --orphan students

      # 6. 전부 삭제 후 students_out만 남김
      - name: Replace tree with students content
        run: |
          git ls-files | xargs -r rm -f
          git ls-files -z --directory | sort -z -r | xargs -0 rmdir 2>/dev/null || true
          cp -r students_out/* .
          cp students_out/.gitignore .
          rm -rf students_out

      # 7. 한 번 커밋 후 force push → 원격 students 브랜치를 이 커밋으로 덮어씀 (히스토리 불필요)
      - name: Commit and push to students
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update ipynb from main (qmd convert)" || true
          git push --force origin students
